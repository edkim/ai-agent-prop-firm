# Development Plan - October 22, 2025

## Implemented: AI-Powered Backtest Routing System

### High-Level Steps Completed

1. **Created BacktestRouterService** - Intelligent routing engine that analyzes natural language prompts
   - Detects earnings queries, date ranges, specific dates, custom exit times
   - Routes to appropriate execution strategy (template API vs custom script)
   - Integrates with DateQueryService for earnings data lookup

2. **Created DateQueryService** - Database query service for special date filtering
   - Supports earnings date queries from database
   - Extensible for other date-based filters

3. **Created ORB Multi-Day Template** - Template for running strategies across multiple dates
   - Supports dynamic date injection
   - Handles custom exit times (noon, etc.)
   - Aggregates results across all dates

4. **Added Intelligent Endpoint** - New `/api/backtests/execute-intelligent` endpoint
   - Accepts natural language prompts
   - Automatically routes to best execution strategy
   - Returns routing decision for transparency

5. **Tested Implementation** - Verified with CRML multi-day backtest
   - Tested "past 9 days with noon exit" query
   - Results documented in CRML_ORB_RESULTS.md
   - Strategy showed 75% win rate, +$311 profit on 100 shares

### Next Steps (Verification)

1. Test simple strategy query through intelligent router
2. Test complex multi-day query through intelligent router
3. Verify routing decisions are optimal
4. Document example queries and expected routing

---

## Current Session: Automatic Data Fetching + Short Position Support

### Context
Previous session crashed while implementing:
1. Automatic data fetching when data is missing
2. Support for short positions on breakdowns (not just long on breakouts)

Target prompt: "Backtest a 5 minute ORB on USAR stock, including short positions on breakdowns"

### High-Level Implementation Steps

#### 1. Add Automatic Data Fetching
- Modify backtest execution flow to check if data exists before running
- If data is missing, automatically fetch it from Polygon API
- Calculate appropriate date range based on trading days needed
- Handle errors gracefully (API limits, no data available, etc.)

**Location**: `backend/src/api/routes/backtests.ts` (execute-intelligent endpoint)

**Implementation**:
1. Parse dates from routing decision
2. For each date, check if data exists using `PolygonService.hasData()`
3. If missing, calculate date range (date + buffer for pre-market data)
4. Call `PolygonService.fetchAndStore()` to fetch missing data
5. Continue with script execution

#### 2. Enhance ORB Template for Short Positions
- Add support for both long (breakout) and short (breakdown) positions
- Update template to accept position direction configuration
- Implement breakdown logic (short below opening range low)
- Track both long and short trades separately in results

**Location**: `backend/src/templates/orb-multiday.template.ts`

**Configuration**:
- `allowLong` (default: true)
- `allowShort` (default: false)

**Logic updates**:
- Track separate long and short positions
- Long: entry on breakout above opening range high, exit on breakdown or time
- Short: entry on breakdown below opening range low, exit on breakout or time
- Handle both positions in same day if configured

#### 3. Update Script Generator
- Add configuration option for position direction (long, short, both)
- Parse prompts to detect intent (e.g., "including short positions")
- Pass configuration to template generation

**Location**: `backend/src/services/script-generator.service.ts`

**Parse prompts for keywords**:
- "short" or "shorts" or "short positions" → set allowShort = true
- "including short" or "both long and short" → set allowLong = true, allowShort = true
- "only short" → set allowLong = false, allowShort = true

### Success Criteria
- ✅ Prompt "Backtest a 5 minute ORB on USAR stock, including short positions on breakdowns" works
- ✅ Data is automatically fetched if not in database
- ✅ Results show both long and short trades
- ✅ Summary includes separate metrics for long vs short performance

---

## Implementation Complete

All improvements have been successfully implemented and tested!

### What Was Implemented

#### 1. Automatic Data Fetching ✅
**Location**: `backend/src/api/routes/backtests.ts`

Added `ensureDataExists()` helper function that:
- Checks if data exists for each trading day before running backtest
- Automatically fetches missing data from Polygon API
- Handles errors gracefully with informative messages
- Logs progress for each date being fetched

**Result**: Successfully fetched 10 days of USAR data automatically (186-192 bars per day)

#### 2. Short Position Support ✅
**Location**: `backend/src/templates/orb-multiday.template.ts`

Enhanced template to support both long and short positions:
- Added `allowLong` and `allowShort` configuration variables
- Implemented breakdown logic (short entry when price breaks below opening range low)
- Track both position types simultaneously (can have long and short on same day)
- Calculate P&L correctly for shorts (entry - exit vs exit - entry for longs)
- Separate tracking of highest price (longs) and lowest price (shorts)

#### 3. Script Generator Updates ✅
**Locations**:
- `backend/src/services/script-generator.service.ts`
- `backend/src/api/routes/backtests.ts`

Added intelligent prompt parsing to detect position direction:
- "including short" → enables both long and short
- "only short" → enables short only
- "breakdown" keyword → enables shorts
- Default → long only (backward compatible)

Template replacement for `TEMPLATE_ALLOW_LONG` and `TEMPLATE_ALLOW_SHORT` variables

#### 4. Enhanced Results Output ✅
Updated JSON output to include:
- `side` field on each trade (LONG or SHORT)
- Separate `long_metrics` and `short_metrics` in summary
- Overall metrics plus per-direction breakdown
- Updated summary text to show trade counts by direction

### Test Results

**Prompt**: "Backtest a 5 minute ORB on USAR stock, including short positions on breakdowns"

**Results**:
- Tested 10 days (2025-10-08 to 2025-10-21)
- Total trades: 12 (5 long, 7 short)
- Overall win rate: 41.7%
- Overall P&L: -$3.72

**Long Performance**:
- Trades: 5
- Winners: 2 (40% win rate)
- Total P&L: -$3.97
- Average P&L: -$0.79

**Short Performance**:
- Trades: 7
- Winners: 3 (42.9% win rate)
- Total P&L: +$0.25
- Average P&L: +$0.04

### Key Insights

1. **Automatic data fetching works perfectly** - No manual data fetch required
2. **Short positions are profitable on USAR** - Shorts had better performance than longs
3. **Some days had both long and short signals** - e.g., 2025-10-10 and 2025-10-20
4. **System is backward compatible** - Existing queries without "short" keyword work as before

### Technical Notes

**Important**: Template files in `src/templates/*.template.ts` need to be manually copied to `dist/templates/` after changes, as TypeScript compiler doesn't copy them automatically.

Command to copy templates:
```bash
cp backend/src/templates/*.template.ts backend/dist/templates/
```
