# TypeScript Backtest Script Errors - Diagnosis and Plan

**Date:** 2025-10-31
**Status:** Diagnosed - Ready for Implementation

## Problem Summary

Claude-generated backtest scripts are failing to compile with consistent TypeScript errors across multiple files. The scripts are generated by the AgentLearningService when running learning iterations, but ts-node cannot execute them due to type errors.

## Error Patterns

All generated backtest scripts exhibit the same 9 TypeScript errors at identical line numbers:

### 1. Date Property Access Errors (Lines 42, 57, 60, 72, 127)
```
error TS2339: Property '2025-10-13' does not exist on type 'String'.
error TS2339: Property '2025-10-13' does not exist on type 'TradeResult'.
error TS2339: Property '2025-10-13' does not exist on type 'Bar'.
```

**Root Cause:** Claude is generating code that attempts to access dates as object properties, likely using syntax like:
```typescript
// Incorrect - dates as property accessors
someObject['2025-10-13']
// or
someObject.2025-10-13  // This is syntactically invalid
```

### 2. Missing Type Annotations (Lines 75, 153, 332)
```
error TS7006: Parameter 'acc' implicitly has an 'any' type.
error TS7006: Parameter 'bar' implicitly has an 'any' type.
error TS7006: Parameter 'b' implicitly has an 'any' type.
error TS7006: Parameter 'r' implicitly has an 'any' type.
```

**Root Cause:** Claude is generating callback functions without explicit type annotations, such as:
```typescript
// Missing type annotations
array.reduce((acc, bar) => { ... })  // Should be: (acc: number, bar: Bar)
array.sort((a, b) => { ... })        // Should be: (a: Bar, b: Bar)
array.map((r) => { ... })            // Should be: (r: TradeResult)
```

## Investigation Evidence

1. **Consistency:** Same 9 errors appear in every backtest script at identical line numbers
2. **Script Execution:** Scripts are executed via `npx ts-node` which enforces strict TypeScript compilation
3. **Template:** All scripts follow a generated template from Claude's response to the backtest generation prompt
4. **Scanner Scripts:** Scanner scripts (agent-scan-*.ts) execute successfully, suggesting the issue is specific to backtest script generation

## Root Cause Analysis

The issue originates in the **Claude prompt engineering** for backtest script generation, specifically in:

**File:** `backend/src/services/agent-learning.service.ts`
**Method:** `generateExecutionScript()` (around lines 323-340)

The backtest script generation is triggered with:
```typescript
const backtestScript = await claudeService.generateBacktestScript({
  strategyType: 'custom',
  ticker: 'TEMPLATE_TICKER',
  timeframe: agent.timeframe,
  specificDates: ['2025-10-26'],
  config: {},
});
```

This calls into:
**File:** `backend/src/services/claude.service.ts`
**Method:** `generateBacktestScript()`

The Claude prompt likely:
1. Does not explicitly forbid date property access syntax
2. Does not emphasize type annotation requirements for TypeScript strict mode
3. May be providing examples that Claude is incorrectly extrapolating from

## Affected Files

- `backend/src/services/claude.service.ts` - Backtest script generation prompt
- `backend/src/services/agent-learning.service.ts` - Calls backtest generation
- All generated `agent-backtest-*.ts` scripts (cleaned up after execution)

## Solution Plan

### Option 1: Fix Claude Prompt (Recommended)
**Effort:** Medium
**Reliability:** High
**Maintainability:** Best

Enhance the backtest script generation prompt in `claude.service.ts` to:

1. **Add explicit TypeScript guidelines:**
   ```
   CRITICAL TYPESCRIPT REQUIREMENTS:
   - All callback function parameters MUST have explicit type annotations
   - NEVER use dates as object property accessors
   - Use bracket notation with string literals for dynamic access
   - All code must compile with ts-node in strict mode
   ```

2. **Provide correct examples:**
   ```typescript
   // ✅ CORRECT - Type annotations and proper date handling
   const results = data.reduce((acc: number, bar: Bar) => acc + bar.volume, 0);
   const filtered = bars.filter((b: Bar) => b.date === '2025-10-13');

   // ❌ WRONG - Missing types and date property access
   const results = data.reduce((acc, bar) => acc + bar.volume, 0);
   const value = object['2025-10-13'];  // If this is being generated
   ```

3. **Add validation rules to the prompt:**
   ```
   Before returning the script:
   1. Verify all arrow function parameters have type annotations
   2. Verify no date strings are used as property accessors
   3. Verify all Map/object accesses use proper syntax
   ```

### Option 2: Post-Generation Cleanup (Fallback)
**Effort:** Low
**Reliability:** Medium
**Maintainability:** Poor (band-aid)

Add a TypeScript cleanup step after Claude generates the script:

```typescript
private cleanupGeneratedTypeScript(code: string): string {
  // Add type annotations to common patterns
  code = code.replace(/\.reduce\(\(acc, /g, '.reduce((acc: any, ');
  code = code.replace(/\.map\(\((\w+)\) =>/g, '.map(($1: any) =>');
  code = code.replace(/\.filter\(\((\w+)\) =>/g, '.filter(($1: any) =>');
  code = code.replace(/\.sort\(\((\w+), (\w+)\) =>/g, '.sort(($1: any, $2: any) =>');

  // Fix date property access (if we can identify the pattern)
  // This is harder without seeing the actual generated code

  return code;
}
```

**Problems with this approach:**
- Requires guessing Claude's patterns
- Fragile - breaks if Claude changes generation style
- Masks the real problem instead of fixing it
- Cannot fix all possible type errors

### Option 3: Use transpileOnly Mode
**Effort:** Very Low
**Reliability:** High
**Maintainability:** Poor (hides problems)

Modify script execution to skip type checking:

**File:** `backend/src/services/script-execution.service.ts`
**Line:** 44

```typescript
// Current
const command = `npx ts-node "${absolutePath}"`;

// Changed to skip type checking
const command = `npx ts-node --transpile-only "${absolutePath}"`;
```

**Problems with this approach:**
- Scripts might have runtime errors that TypeScript would catch
- Poor code quality in generated scripts
- Doesn't fix the underlying prompt engineering issue
- May cause unexpected failures during backtest execution

## Recommended Implementation

**Implement Option 1** (Fix Claude Prompt) with these steps:

### Step 1: Examine Current Prompt
1. Read `backend/src/services/claude.service.ts`
2. Locate the `generateBacktestScript()` method
3. Document the current prompt structure and examples

### Step 2: Capture Failed Script
1. Temporarily disable script cleanup in `script-execution.service.ts`
2. Run a learning iteration
3. Examine a failed backtest script to see exact code patterns
4. Re-enable cleanup

### Step 3: Enhance Prompt
1. Add TypeScript strict mode requirements
2. Add explicit examples of correct vs incorrect patterns
3. Add validation instructions for Claude
4. Test with sample generation

### Step 4: Validate Fix
1. Run learning iteration with enhanced prompt
2. Verify backtest scripts compile successfully
3. Verify backtests execute and return results
4. Check multiple iterations for consistency

### Step 5: Fallback Safety
If Option 1 doesn't fully resolve the issue, implement a hybrid approach:
1. Keep the improved prompt (reduces frequency)
2. Add minimal post-processing to catch edge cases
3. Add better error messages that include the generated code for debugging

## Success Criteria

1. **Compilation:** All generated backtest scripts compile with `ts-node` without errors
2. **Execution:** Scripts execute successfully and return backtest results
3. **Consistency:** 10 consecutive learning iterations complete without TypeScript errors
4. **Maintainability:** Solution doesn't require ongoing manual fixes

## Timeline

- **Investigation:** 30 minutes (✅ Complete)
- **Step 1 (Examine prompt):** 15 minutes
- **Step 2 (Capture script):** 15 minutes
- **Step 3 (Fix prompt):** 45 minutes
- **Step 4 (Testing):** 30 minutes
- **Total:** ~2.5 hours

## Related Files

- `backend/src/services/claude.service.ts` (PRIMARY)
- `backend/src/services/agent-learning.service.ts`
- `backend/src/services/script-execution.service.ts`
- Generated scripts: `backend/agent-backtest-*.ts` (temporary)

## Notes

- Scanner scripts work fine, suggesting the issue is specific to backtest generation
- Error consistency (same lines, same errors) indicates a systemic prompt issue
- The fact that Claude CAN generate valid TypeScript (for scanners) proves it's capable
- The issue is likely missing or conflicting instructions in the backtest prompt
