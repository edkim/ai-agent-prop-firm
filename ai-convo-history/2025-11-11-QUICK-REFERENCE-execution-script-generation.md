# Quick Reference: Custom Execution Script Generation

## Where Scripts Are Generated

### Main Entry Point
- **File**: `backend/src/services/agent-learning.service.ts`
- **Method**: `generateStrategy()` (lines 312-440)
- **Called by**: `runIteration()` (line 89)

### Claude API Calls

**Iteration 1 - Strategy Aligned**:
```typescript
// File: claude.service.ts (lines 1646-1758)
await claude.generateExecutionScriptFromStrategy({
  agentInstructions: agent.instructions,
  agentPersonality,
  patternFocus: agent.pattern_focus,
  tradingStyle: agent.trading_style,
  riskTolerance: agent.risk_tolerance,
  marketConditions: agent.market_conditions,
  scannerContext: scannerResult.explanation
});
```

**Iteration 2+ - Learning Refinement**:
```typescript
// File: claude.service.ts (lines 1763-1979)
await claude.generateExecutionScript({
  agentPersonality,
  winningTemplate: previousIteration.winning_template,
  templatePerformances: previousIteration.backtest_results.templateResults,
  executionAnalysis: previousIteration.expert_analysis.execution_analysis,
  agentKnowledge: knowledgeSummary,
  scannerContext: scannerResult.explanation,
  actualScannerSignals: scanResults.slice(0, 5)
});
```

## The Fallback Text Pattern

**Location**: `agent-learning.service.ts` line 438

```typescript
executionPrompt: executionResult?.prompt || `Generated ${iterationNumber === 1 ? 'initial' : 'refined'} execution script`
```

**What This Means**:
- If Claude response has `.prompt` field → use it
- Otherwise → use fallback: "Generated initial execution script" or "Generated refined execution script"

**Current Reality**: 
- Claude methods don't return `.prompt` field
- Fallback text is ALWAYS used
- This is by design (not an error)

## What Gets Stored in Database

**Table**: `agent_iterations`

```sql
INSERT INTO agent_iterations (
  execution_script,        -- Actual TypeScript code generated by Claude
  execution_prompt,        -- "Generated initial/refined execution script" (fallback)
  scanner_prompt,          -- Scanner query used
  version_notes            -- Iteration description
)
```

## Key Return Values

### From generateExecutionScriptFromStrategy()
```typescript
{
  script: string,          // TypeScript code
  rationale: string,       // Human-readable explanation
  tokenUsage: {            // Claude API usage
    inputTokens: number,
    outputTokens: number
  }
  // NO .prompt field - so fallback will be used
}
```

### From generateExecutionScript()
```typescript
{
  script: string,          // TypeScript code
  rationale: string        // Human-readable explanation
  // NO .prompt field - so fallback will be used
}
```

## Decision Flow

```
Agent Learning Loop:
├─ Iteration 1?
│  ├─ Yes → generateExecutionScriptFromStrategy()
│  │        → executionPrompt = "Generated initial execution script"
│  └─ No → Check previous iteration results
│         └─ Has results? 
│            ├─ Yes → generateExecutionScript() (with learnings)
│            │        → executionPrompt = "Generated refined execution script"
│            └─ No → Skip custom execution (use templates only)
└─ Store in database with fallback prompt
```

## Code Snippets for Finding/Modifying

### Finding All Prompt Generation
```bash
grep -r "executionPrompt\|execution_prompt" backend/src/
```

### Finding Fallback Text
```bash
grep -n "Generated.*execution script" backend/src/services/agent-learning.service.ts
# Returns line 438
```

### Finding Claude Method Calls
```bash
grep -n "generateExecutionScript" backend/src/services/agent-learning.service.ts
# Returns: line 114, 385, 408
```

## Related Files

1. **claude.service.ts**
   - Lines 1646-1758: generateExecutionScriptFromStrategy()
   - Lines 1763-1979: generateExecutionScript()

2. **agent-learning.service.ts**
   - Line 438: Fallback executionPrompt
   - Lines 312-440: generateStrategy() orchestrator
   - Lines 379-425: Both Claude method calls
   - Lines 105-127: Special signal-aware regeneration

3. **Database**
   - `agent_iterations.execution_prompt` column
   - `agent_iterations.execution_script` column

---

**Quick Reference Created**: 2025-11-11
**For detailed info**, see: `2025-11-11-custom-execution-script-generation-analysis.md`
