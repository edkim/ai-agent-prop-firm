# Custom Execution Script Generation Prompt

**Location:** `backend/src/services/claude.service.ts` lines 1764-1983

## System Prompt

```
You are an expert algorithmic trader specializing in execution strategy optimization. ${agentPersonality}

Your task is to generate a custom execution script that improves upon previous template performance by incorporating learned insights.
```

## User Prompt Structure

The prompt includes the following sections:

1. **Previous Winning Template**
2. **Template Performance Comparison** - Win rates, Sharpe ratios, profit factors for all templates
3. **Execution Analysis from Previous Iteration**
4. **Agent's Accumulated Knowledge**
5. **Scanner Context**
6. **CRITICAL - Signal Interface from Scanner** - Dynamically generated from actual scanner output
7. **Example Signal from Scanner** - JSON sample of actual signal
8. **CRITICAL - How to Determine Trade Direction:**

```typescript
**CRITICAL - How to Determine Trade Direction:**
1. **ALWAYS use signal.direction if it exists!** The scanner already analyzed the setup and determined the correct direction.
2. If signal.direction is not provided, then infer from metrics:
   - For breakout patterns: Usually LONG (buying momentum)
   - For rejection patterns: Check if 'rejection_type' field exists
   - For mean reversion: Analyze price vs reference level (VWAP, moving average)
   - Default: Use price action context

Example: `const side: 'LONG' | 'SHORT' = signal.direction || 'LONG';  // Use scanner direction if provided`
```

## Full Template Structure

The prompt provides a complete TypeScript template showing:

- Import statements with correct paths
- Signal interface (dynamically generated from actual scanner output)
- Trade interface with all required fields
- `executeSignal()` function structure
- `executeSignals()` loop
- Main execution flow

## Key Requirements in Prompt

1. **Align with Strategy** - Implement the strategy described in agent instructions
2. **Match Risk Profile** - Aggressive/Moderate/Conservative risk management
3. **Match Trading Style** - Day trader/Swing trader/Scalper timing rules
4. **Direction Handling** - ALWAYS read direction from `signal.direction` field
5. **Output Format** - Return ONLY the execution code block

## Current Issue

Despite the explicit instruction "ALWAYS use signal.direction if it exists!", iteration 4's generated script hardcoded:

```typescript
// Line 137 in iteration 4 script
const side: 'LONG' | 'SHORT' = 'SHORT';
```

Even though all signals had `"direction": "LONG"`.

## Proposed Fix

Make the prompt even more explicit with anti-patterns:

```typescript
**⚠️ CRITICAL - Trade Direction (DO NOT HARDCODE!):**

YOU MUST use signal.direction! DO NOT hardcode 'LONG' or 'SHORT'!

Example (COPY THIS EXACTLY):
\`\`\`typescript
// Use the direction from the scanner signal
if (!signal.direction) {
  throw new Error('Signal missing direction field');
}
const side: 'LONG' | 'SHORT' = signal.direction;
\`\`\`

**WRONG (DO NOT DO THIS):**
❌ const side = 'LONG';
❌ const side = 'SHORT';
❌ const side = someInferredValue;
```

---

## Scanner Script Generation Prompt

**Note:** The scanner script is generated by a different method in the learning process. To find the scanner generation prompt, search for the strategy generation method in `claude.service.ts` or `agent-learning.service.ts`.
