# Custom Execution Scripts Generation - Finding Summary

## Overview
Custom execution scripts are generated by Claude AI to implement trading strategies. The system uses a comprehensive prompt that instructs Claude how to write TypeScript backtesting code.

## Key Files

### 1. Claude Service (Primary Generator)
**File:** `/Users/edwardkim/Code/ai-backtest/backend/src/services/claude.service.ts`

This is the core service that generates execution scripts. It contains two main methods:

#### Method 1: `generateExecutionScriptFromStrategy()` (Lines 1647-1779)
- **Used in:** Iteration 1 (first learning iteration)
- **Input Parameters:**
  - `agentInstructions`: Strategy description from the agent
  - `agentPersonality`: Trading style + risk tolerance
  - `patternFocus`: Specific patterns to target
  - `tradingStyle`: Day trader, swing trader, etc.
  - `riskTolerance`: Conservative, moderate, aggressive
  - `marketConditions`: Market environment descriptors
  - `scannerContext`: Description of what the scanner found

#### Method 2: `generateExecutionScript()` (Lines 1784-2046)
- **Used in:** Iteration 2+ (subsequent learning iterations)
- **Input Parameters:**
  - `agentPersonality`: Same as above
  - `winningTemplate`: Best-performing template from previous iteration
  - `templatePerformances`: Performance metrics from all templates
  - `executionAnalysis`: Detailed execution analysis from previous iteration
  - `agentKnowledge`: Accumulated learnings from prior iterations
  - `scannerContext`: Scanner explanation
  - `actualScannerSignals`: Sample signals from actual scanner output (NEW in iteration 2+)

### 2. System Prompt (Lines 258-573)
The system prompt is a **comprehensive 316-line instruction set** that tells Claude exactly how to write execution scripts.

#### Key Sections:
1. **Script Structure** (Lines 263-335): Template showing basic backtest layout
2. **Data & Time Handling** (Lines 337-343): Format requirements (HH:MM:SS)
3. **Indicators Available** (Lines 345-360): List of helper functions for technical analysis
4. **Trade Execution Pattern** (Lines 362-412): Next-bar entry logic with proper position tracking
5. **Trade Limiting** (Lines 414-430): How to cap trades per day
6. **Signal-Based Execution** (Lines 432-506): Special handling for scanner signals
7. **TypeScript Requirements** (Lines 508-533): Critical type system rules
8. **Response Format** (Lines 545-561): Expected output structure with DATES, SCRIPT, ASSUMPTIONS, etc.

#### Critical Rules in System Prompt:
- **NULL ARRAYS:** Never use `[null]`, always use empty array `[]`
- **TYPE MIXING:** Use union types `false | 'LONG' | 'SHORT'` not boolean
- **LOOKAHEAD BIAS:** Must use next-bar execution, never enter and exit on same bar
- **Time Format:** Use HH:MM:SS not HH:MM
- **Field Names:** Scanner fields are `signal_date` and `signal_time` (NOT `date` and `time`)
- **Metric Access:** Always calculate metrics, don't assume they exist in signals

### 3. User Message Builder (Lines 579-591)
Creates the user prompt that includes:
- The user's trading strategy description
- Ticker and timeframe parameters
- Instructions to replace TEMPLATE_TICKER with actual ticker
- Request for complete, runnable TypeScript script

### 4. Scanner Script Generation
**Method:** `generateScannerScript()` (Lines 193-253)

Uses a separate system prompt (`buildScannerSystemPrompt()`, Lines 676-1084) that is **408 lines** and includes:
- Detailed rules for choosing between intraday (`ohlcv_data`) vs daily (`daily_metrics`) tables
- VWAP calculation patterns
- Scanner script examples (both intraday and daily)
- Critical validation checklist
- Output size limiting (top 500 patterns max)

### 5. Agent Learning Service
**File:** `/Users/edwardkim/Code/ai-backtest/backend/src/services/agent-learning.service.ts`

#### Orchestration of Script Generation (Lines 312-439)
The `generateStrategy()` method:
1. Gets agent's accumulated knowledge
2. Builds scanner query (uses agent instructions if available, otherwise pattern focus)
3. Calls Claude to generate scanner script
4. For iteration 1: Calls `generateExecutionScriptFromStrategy()`
5. For iteration 2+: Calls `generateExecutionScript()` with previous learnings

#### Script Regeneration (Lines 103-127)
In iteration 2+, execution script is regenerated with actual scanner signals to ensure it matches the real signal structure.

## The Prompt Hierarchy

### Scanner Generation Prompt
```
System Prompt (408 lines)
  ├─ Data table selection rules (intraday vs daily)
  ├─ VWAP calculation patterns
  ├─ Scanner script examples
  └─ Validation checklist + output limiting
    ↓
User Message
  ├─ Query/strategy description
  ├─ Universe
  └─ Date range
```

### Execution Script Generation Prompt (Iteration 1)
```
System Prompt (316 lines)
  ├─ Script structure template
  ├─ Data & time handling rules
  ├─ Available indicators
  ├─ Trade execution patterns
  ├─ Critical TypeScript rules
  └─ Response format specifications
    ↓
User Message (Strategy-Based)
  ├─ Agent instructions
  ├─ Agent personality (trading style + risk tolerance)
  ├─ Pattern focus list
  ├─ Trading style descriptor
  ├─ Risk tolerance level
  └─ Market conditions
```

### Execution Script Generation Prompt (Iteration 2+)
```
System Prompt (same 316 lines as above)
    ↓
User Message (Learning-Based)
  ├─ Previous winning template
  ├─ Template performance comparison
  ├─ Execution analysis from previous iteration
  ├─ Agent's accumulated knowledge
  ├─ Scanner context
  ├─ Sample signals from actual scanner (NEW)
  └─ Detailed lookahead bias prevention examples
```

## Critical Implementation Details

### Signal Interface Inference (Lines 1569-1642)
Claude can infer the signal interface structure from actual scanner output and provide hints about trade direction.

### Lookahead Bias Prevention (Emphasized in Both Prompts)
The system emphasizes:
1. Use next-bar execution (enter on bar N, exit earliest on bar N+1)
2. Never check stops/targets on same bar as entry
3. Use `entryBar.open` not high/low from previous bar
4. Start exit loop from `entryBarIndex + 1`

### Token Management
- Scanner generation: 20,000 max tokens
- Execution script generation: 16,000-20,000 max tokens
- Temperature: 0.0 (deterministic, not creative)

## File Locations

**Generation Service:**
- `/Users/edwardkim/Code/ai-backtest/backend/src/services/claude.service.ts` (2,050 lines)

**Learning Orchestration:**
- `/Users/edwardkim/Code/ai-backtest/backend/src/services/agent-learning.service.ts` (1,321 lines)

**Generated Scripts Output:**
- `/Users/edwardkim/Code/ai-backtest/backend/generated-scripts/` (success and failed subdirectories)

## Prompt Engineering Techniques Used

1. **Structured Examples:** Shows exactly what valid code looks like
2. **Critical Requirements:** Uses WARNING text, caps, and emoji to highlight important rules
3. **Counter-Examples:** Shows both wrong and correct implementations
4. **Type System Emphasis:** Entire section dedicated to TypeScript mistakes
5. **Iterative Learning:** Passes previous iteration results to improve next iteration
6. **Flexible Metric Access:** Code that doesn't assume specific metric fields exist
7. **Pattern Libraries:** Provides reusable code patterns for common scenarios
