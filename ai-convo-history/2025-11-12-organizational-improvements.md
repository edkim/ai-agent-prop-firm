# 2025-11-12: Organizational Improvements for Learning Agent Iterations

## Overview
Implemented three critical organizational improvements to fix confusion about iteration tracking and script versioning:

1. âœ… **Git Commit Tracking**: Store which git commit generated each iteration
2. ðŸš§ **Better File Naming**: Include iteration number and agent name in script filenames
3. ðŸš§ **Frontend Script Display**: Show post-embedding script (with signals) instead of pre-embedding version

## Problem Statement

User reported three major problems:
1. Confusion about which scripts correspond to which code changes
2. Frontend showing pre-embedding script instead of final executed script (with signals embedded)
3. No tracking of which git commit generated each iteration

These issues made debugging nearly impossible when iterations produced unexpected results.

## Solutions Implemented

### 1. Git Commit Tracking âœ… COMPLETED

**Files Modified:**
- `/Users/edwardkim/Code/ai-backtest/backend/src/database/schema.sql` (lines 775-776)
  - Added `git_commit_hash TEXT` column to `agent_iterations` table

- `/Users/edwardkim/Code/ai-backtest/backend/migrations/2025-11-12-add-git-commit-tracking.sql`
  - Created migration to add column to existing databases

- `/Users/edwardkim/Code/ai-backtest/backend/src/services/agent-learning.service.ts`
  - Added `import { execSync } from 'child_process'` (line 32)
  - Added `getGitCommitHash()` helper method (lines 1006-1013)
  - Added `git_commit_hash` to iteration object (line 1038)
  - Updated INSERT statement to include git_commit_hash (lines 1042-1069)

**How It Works:**
- When an iteration is created, the system captures the current git commit hash using `git rev-parse HEAD`
- Hash is stored in the `agent_iterations` table
- Future queries can filter/group by commit to see which iterations were generated by which code version

**Benefits:**
- Easy to correlate iteration results with specific code changes
- Can identify if a bug was introduced in a specific commit
- Provides full audit trail of code-to-iteration mapping

### 2. Better File Naming âœ… COMPLETED

**Current Problem:**
Scripts were previously named with UUID only: `{uuid}-custom-execution.ts`

**Implemented Solution:**
Scripts are now named: `iter{N}-{agentName}-{uuid}-custom-execution.ts`

**Example:**
- Before: `6ad24195-dad8-4617-a306-264b0df2a606-custom-execution.ts`
- After: `iter8-orb-agent-6ad24195-custom-execution.ts`

**Files Modified:**
- `/Users/edwardkim/Code/ai-backtest/backend/src/services/agent-learning.service.ts`
  - Line 494: Updated `runBacktests` function signature to accept `agentName: string, iterationNumber: number`
  - Line 136: Updated call site to pass `agent.name` and `iterationNumber`
  - Lines 622-623: Added sanitization and updated script path generation:
    ```typescript
    const sanitizedAgentName = agentName.toLowerCase().replace(/[^a-z0-9]/g, '-');
    const scriptPath = path.join(__dirname, '../../generated-scripts/success', new Date().toISOString().split('T')[0], `iter${iterationNumber}-${sanitizedAgentName}-${scriptId}-custom-execution.ts`);
    ```

**Benefits:**
- Scripts are now easily identifiable by iteration number and agent name
- No need to cross-reference UUIDs with database records
- File system organization matches logical iteration progression

### 3. Frontend Script Display ðŸš§ PENDING

**Current Problem:**
Frontend displays the pre-embedding script (`executionScript`) which shows `const signals = []`

**Root Cause:**
The backend saves the script to disk with signals embedded (`scriptWithSignals`), but returns the original `executionScript` in the API response

**Planned Fix:**
1. Store the path to the post-embedding script file
2. Return the post-embedding script content in API responses
3. Or: Store both versions and provide a toggle in frontend ("Generated" vs "Executed with Signals")

**Files to Modify:**
- `agent-learning.service.ts` (lines 618-644): Save script path with signals
- Frontend iteration view component: Update to display correct script version

## Database Schema Changes

### agent_iterations Table (Updated)

```sql
CREATE TABLE IF NOT EXISTS agent_iterations (
  id TEXT PRIMARY KEY,
  agent_id TEXT NOT NULL,
  iteration_number INTEGER NOT NULL,

  -- Strategy under test
  scan_script TEXT NOT NULL,
  execution_script TEXT NOT NULL,
  version_notes TEXT,
  manual_guidance TEXT,

  -- Results
  signals_found INTEGER,
  backtest_results TEXT,
  win_rate REAL,
  sharpe_ratio REAL,
  total_return REAL,

  -- Analysis
  expert_analysis TEXT,
  refinements_suggested TEXT,

  -- Status
  iteration_status TEXT DEFAULT 'completed',

  -- Git tracking (NEW)
  git_commit_hash TEXT,

  created_at TEXT NOT NULL,
  FOREIGN KEY (agent_id) REFERENCES trading_agents(id) ON DELETE CASCADE
);
```

## Migration Instructions

To apply the git commit tracking to existing database:

```bash
cd /Users/edwardkim/Code/ai-backtest/backend
sqlite3 backtesting.db < migrations/2025-11-12-add-git-commit-tracking.sql
```

## Next Steps

1. Complete file naming improvements:
   - Update script path generation to include iteration number and agent name
   - Test with new iteration to verify naming works correctly

2. Fix frontend script display:
   - Option A: Return post-embedding script in API response
   - Option B: Store both script versions and add frontend toggle
   - Update frontend component to display correct version

3. Test end-to-end:
   - Run new learning iteration
   - Verify git commit is captured
   - Verify file is named correctly with iteration number
   - Verify frontend shows script with embedded signals

4. Documentation:
   - Update API documentation with new git_commit_hash field
   - Update developer docs with new file naming convention

## Related Files

**Backend:**
- `src/database/schema.sql`
- `src/services/agent-learning.service.ts` (lines 1006-1072)
- `migrations/2025-11-12-add-git-commit-tracking.sql`

**Frontend:**
- TBD: Component that displays iteration scripts

## Testing Plan

1. Run database migration on development database
2. Start learning iteration and verify:
   - Git commit hash is captured and stored
   - Script files are named with iteration number
   - Frontend displays post-embedding script
3. Test edge cases:
   - Iteration with 0 signals
   - Iteration with 500 signals
   - Multiple iterations in rapid succession
4. Verify backwards compatibility:
   - Old iterations without git_commit_hash still load correctly
   - Old script files with UUID-only names still work
